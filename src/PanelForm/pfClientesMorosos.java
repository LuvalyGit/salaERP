/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package PanelForm;

import Conexion.ExeSql;
import Dialogos.jdCliBlogAgregar;
import Dialogos.jdDesbloquearCliente;
import Formularios.fmMain;
import java.sql.ResultSet;
import java.text.SimpleDateFormat;
import javax.swing.ImageIcon;
import javax.swing.JLabel;
import Utilidades.ImgTabla;
import java.awt.Image;
import java.net.URL;
import javax.swing.Icon;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author David Alcaman
 */
public class pfClientesMorosos extends javax.swing.JPanel {

    
    public pfClientesMorosos() {
        initComponents();
        GrillaBlog.setDefaultRenderer(Object.class, new ImgTabla());
        Grilla.getSelectionModel().addListSelectionListener(new ListSelectionListener() {
            //Se ejecuta automáticamente cada vez que se hace una nueva selección. 
            @Override
            public void valueChanged(ListSelectionEvent e) {
                if(Grilla.getSelectedRowCount()>0)
                {
                    CargaBlog(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString(), Grilla.getValueAt(Grilla.getSelectedRow(), 2).toString());
                    CargaDocVencidos(Grilla.getValueAt(Grilla.getSelectedRow(),0).toString(),Grilla.getValueAt(Grilla.getSelectedRow(),2).toString());
                    CargaOCRetenidas(Grilla.getValueAt(Grilla.getSelectedRow(),0).toString(),Grilla.getValueAt(Grilla.getSelectedRow(),2).toString());
                }
                    
            }

        });
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        jScrollPane1 = new javax.swing.JScrollPane();
        Grilla = new javax.swing.JTable();
        jPanel1 = new javax.swing.JPanel();
        rbOc = new javax.swing.JRadioButton();
        rbTodos = new javax.swing.JRadioButton();
        btBuscar = new javax.swing.JButton();
        jPanel2 = new javax.swing.JPanel();
        btDesbloquear = new javax.swing.JButton();
        jPanel3 = new javax.swing.JPanel();
        jScrollPane2 = new javax.swing.JScrollPane();
        GrillaDoc = new javax.swing.JTable();
        jScrollPane3 = new javax.swing.JScrollPane();
        GrillaBlog = new javax.swing.JTable();
        jPanel4 = new javax.swing.JPanel();
        jScrollPane5 = new javax.swing.JScrollPane();
        GrillaOCC = new javax.swing.JTable();
        chkContactos = new javax.swing.JCheckBox();
        chkPagos = new javax.swing.JCheckBox();
        chkBloqueos = new javax.swing.JCheckBox();
        btEmail = new javax.swing.JButton();
        btAgregarBlog = new javax.swing.JButton();
        btEliminaBlog = new javax.swing.JButton();

        Grilla.setAutoCreateRowSorter(true);
        Grilla.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null, null},
                {null, null, null, null, null, null},
                {null, null, null, null, null, null},
                {null, null, null, null, null, null}
            },
            new String [] {
                "Rut", "Nombre", "Codigo", "Estado", "Días", "Dias OC"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Integer.class, java.lang.Integer.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        Grilla.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        jScrollPane1.setViewportView(Grilla);
        if (Grilla.getColumnModel().getColumnCount() > 0) {
            Grilla.getColumnModel().getColumn(0).setMinWidth(90);
            Grilla.getColumnModel().getColumn(0).setPreferredWidth(90);
            Grilla.getColumnModel().getColumn(0).setMaxWidth(90);
            Grilla.getColumnModel().getColumn(1).setMinWidth(350);
            Grilla.getColumnModel().getColumn(1).setPreferredWidth(400);
            Grilla.getColumnModel().getColumn(2).setMinWidth(70);
            Grilla.getColumnModel().getColumn(2).setPreferredWidth(70);
            Grilla.getColumnModel().getColumn(2).setMaxWidth(70);
            Grilla.getColumnModel().getColumn(3).setMinWidth(75);
            Grilla.getColumnModel().getColumn(3).setPreferredWidth(75);
            Grilla.getColumnModel().getColumn(3).setMaxWidth(75);
            Grilla.getColumnModel().getColumn(4).setMinWidth(45);
            Grilla.getColumnModel().getColumn(4).setPreferredWidth(45);
            Grilla.getColumnModel().getColumn(4).setMaxWidth(45);
            Grilla.getColumnModel().getColumn(5).setMinWidth(55);
            Grilla.getColumnModel().getColumn(5).setPreferredWidth(55);
            Grilla.getColumnModel().getColumn(5).setMaxWidth(55);
        }

        jPanel1.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        buttonGroup1.add(rbOc);
        rbOc.setSelected(true);
        rbOc.setText("Bloqueados con Orden de Compra");

        buttonGroup1.add(rbTodos);
        rbTodos.setText("Todos los Bloqueados");

        btBuscar.setText("Buscar");
        btBuscar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btBuscarActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(rbTodos)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(rbOc)
                        .addGap(84, 84, 84)
                        .addComponent(btBuscar)))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(22, 22, 22)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(rbOc)
                    .addComponent(btBuscar))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(rbTodos)
                .addContainerGap(29, Short.MAX_VALUE))
        );

        jPanel2.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        btDesbloquear.setText("Desbloquear");
        btDesbloquear.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btDesbloquearActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(btDesbloquear)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel2Layout.createSequentialGroup()
                .addGap(5, 5, 5)
                .addComponent(btDesbloquear)
                .addGap(5, 5, 5))
        );

        jPanel3.setBorder(javax.swing.BorderFactory.createTitledBorder("Facturas Vencidas"));

        GrillaDoc.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null},
                {null, null, null, null}
            },
            new String [] {
                "Numero", "Fecha", "Días", "Monto"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Double.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, true
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane2.setViewportView(GrillaDoc);
        if (GrillaDoc.getColumnModel().getColumnCount() > 0) {
            GrillaDoc.getColumnModel().getColumn(1).setHeaderValue("");
            GrillaDoc.getColumnModel().getColumn(2).setMinWidth(40);
            GrillaDoc.getColumnModel().getColumn(2).setPreferredWidth(40);
            GrillaDoc.getColumnModel().getColumn(2).setMaxWidth(40);
        }

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jScrollPane2, javax.swing.GroupLayout.DEFAULT_SIZE, 346, Short.MAX_VALUE)
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel3Layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jScrollPane2, javax.swing.GroupLayout.PREFERRED_SIZE, 126, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(258, 258, 258))
        );

        GrillaBlog.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "", "Historial", "id"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        GrillaBlog.setGridColor(new java.awt.Color(255, 255, 255));
        jScrollPane3.setViewportView(GrillaBlog);
        if (GrillaBlog.getColumnModel().getColumnCount() > 0) {
            GrillaBlog.getColumnModel().getColumn(0).setMinWidth(30);
            GrillaBlog.getColumnModel().getColumn(0).setPreferredWidth(30);
            GrillaBlog.getColumnModel().getColumn(0).setMaxWidth(30);
            GrillaBlog.getColumnModel().getColumn(2).setMinWidth(0);
            GrillaBlog.getColumnModel().getColumn(2).setPreferredWidth(0);
            GrillaBlog.getColumnModel().getColumn(2).setMaxWidth(0);
        }

        jPanel4.setBorder(javax.swing.BorderFactory.createTitledBorder("Ordenes Retenidas"));

        GrillaOCC.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Orden", "Días", "Monto"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Double.class
            };
            boolean[] canEdit = new boolean [] {
                true, false, true
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane5.setViewportView(GrillaOCC);
        if (GrillaOCC.getColumnModel().getColumnCount() > 0) {
            GrillaOCC.getColumnModel().getColumn(1).setMinWidth(40);
            GrillaOCC.getColumnModel().getColumn(1).setPreferredWidth(40);
            GrillaOCC.getColumnModel().getColumn(1).setMaxWidth(40);
        }

        javax.swing.GroupLayout jPanel4Layout = new javax.swing.GroupLayout(jPanel4);
        jPanel4.setLayout(jPanel4Layout);
        jPanel4Layout.setHorizontalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jScrollPane5, javax.swing.GroupLayout.DEFAULT_SIZE, 272, Short.MAX_VALUE)
        );
        jPanel4Layout.setVerticalGroup(
            jPanel4Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel4Layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jScrollPane5, javax.swing.GroupLayout.PREFERRED_SIZE, 126, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(254, 254, 254))
        );

        chkContactos.setSelected(true);
        chkContactos.setText("Contactos");
        chkContactos.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                chkContactosActionPerformed(evt);
            }
        });

        chkPagos.setText("Pagos");
        chkPagos.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                chkPagosActionPerformed(evt);
            }
        });

        chkBloqueos.setText("Bloqueos");
        chkBloqueos.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                chkBloqueosActionPerformed(evt);
            }
        });

        btEmail.setText("email");
        btEmail.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btEmailActionPerformed(evt);
            }
        });

        btAgregarBlog.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/Agregar.png"))); // NOI18N
        btAgregarBlog.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btAgregarBlogActionPerformed(evt);
            }
        });

        btEliminaBlog.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/Cancel16.png"))); // NOI18N
        btEliminaBlog.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btEliminaBlogActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 775, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jScrollPane3)
                            .addGroup(layout.createSequentialGroup()
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addGroup(layout.createSequentialGroup()
                                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                                            .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                            .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                        .addComponent(jPanel4, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                                    .addGroup(layout.createSequentialGroup()
                                        .addComponent(btAgregarBlog, javax.swing.GroupLayout.PREFERRED_SIZE, 26, javax.swing.GroupLayout.PREFERRED_SIZE)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                        .addComponent(btEliminaBlog, javax.swing.GroupLayout.PREFERRED_SIZE, 26, javax.swing.GroupLayout.PREFERRED_SIZE)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                        .addComponent(btEmail)
                                        .addGap(18, 18, 18)
                                        .addComponent(chkContactos)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                        .addComponent(chkBloqueos)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                        .addComponent(chkPagos)))
                                .addGap(0, 0, Short.MAX_VALUE))))
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 465, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(jPanel4, javax.swing.GroupLayout.PREFERRED_SIZE, 0, Short.MAX_VALUE)
                            .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, 169, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addGap(5, 5, 5)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(btAgregarBlog)
                            .addComponent(btEliminaBlog)
                            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                .addComponent(btEmail)
                                .addComponent(chkContactos)
                                .addComponent(chkPagos)
                                .addComponent(chkBloqueos)))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, 0, Short.MAX_VALUE)
                        .addContainerGap())))
        );
    }// </editor-fold>//GEN-END:initComponents
    private void CargaOCRetenidas(String Rut,String Codigo_Oc){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel TableModel = (DefaultTableModel) GrillaOCC.getModel();
        
        
        while(TableModel.getRowCount()>0)
                        TableModel.removeRow(0);    
        
        try {
            Rs = Sql.Select("select orden,totaldocto,current_date - cast(femision as date) as dias from occh where rut="+ Rut +" and codigo_oc="+ Codigo_Oc +" and estado in (0,1)");
                
                while(Rs.next()){
                    TableModel.addRow(new Object[]{Rs.getString("orden").trim(), 
                                               Rs.getString("dias"), 
                                               Rs.getDouble("totaldocto"),
                                               });
                }
                
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }
    }
    
    private void CargaMorosos(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel TableModel = (DefaultTableModel) Grilla.getModel();
        String Query;
        
        while(TableModel.getRowCount()>0)
                        TableModel.removeRow(0);        
        
        try {
            Query = "select cc.rut, c.nombre, cc.codigo_oc,'Bloqueado' as estado,cc.diasvencidos,count(oc.*) as tiene,current_date - min(cast(oc.femision as date)) as diasoc\n" +
                    "from clicontacto cc\n" +
                    "left join cliente c on c.rut=cc.rut\n" +
                    "left join occh oc on oc.rut=cc.rut and oc.codigo_oc=cc.codigo_oc and oc.estado in (0,1) and oc.orden not in (select orden from cli_desbloqueo where rut=oc.rut and codigo_oc=oc.codigo_oc)\n" +
                    "where cc.bloqueo=1\n";
            if(rbOc.isSelected())
                Query = Query + "and oc.orden is not null\n";
            
            Query = Query + "group by cc.rut, c.nombre, cc.codigo_oc";
            Rs = Sql.Select(Query);
            
            while(Rs.next()){
                
                TableModel.addRow(new Object[]{Rs.getString("rut").trim(), 
                                               Rs.getString("nombre").trim(), 
                                               Rs.getString("codigo_oc").trim(),
                                               Rs.getString("estado").trim(),
                                               Rs.getInt("diasvencidos"),
                                               Rs.getInt("diasoc")
                                               });
            }
            
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }
    }
    private void CargaDocVencidos(String Rut,String Codigo_Oc){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel tm = (DefaultTableModel) GrillaDoc.getModel();
        
        while(tm.getRowCount()>0)
                        tm.removeRow(0);        
        try {
            Rs = Sql.Select("select nrodocto,femision,current_date-femision as dias, monto\n" +
                            "from cli_cuentasxcobrar\n" +
                            "where current_date - femision >= (select valor from par_general where tipo='PLAZOSCOBRANZA' and codigo=1)\n" +
                            "and rut="+ Rut +"\n" +
                            "and codigo_oc=" + Codigo_Oc + "\n" + 
                            "and estado < 3");
            while(Rs.next()){
                 tm.addRow(new Object[]{Rs.getString("nrodocto").trim(), 
                                               Rs.getString("femision").trim(), 
                                               Rs.getString("dias").trim(),
                                               Rs.getDouble("monto")
                                               });
            }
            
            
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }
        
        
        
    }
    private void CargaBlog(String Rut,String Codigo_Oc){
        ExeSql Sql= new ExeSql();
        ResultSet Rs;
        GrillaBlog.setDefaultRenderer(Object.class, new ImgTabla());
        DefaultTableModel tm = (DefaultTableModel) GrillaBlog.getModel();
        SimpleDateFormat sdf = new SimpleDateFormat("dd-MMM-yyyy - hh:mm");
        SimpleDateFormat sdf2 = new SimpleDateFormat("dd-MMM-yyyy");
        
        JLabel lbCall = new JLabel();
        JLabel lbMail = new JLabel();
        JLabel lbBloqueo = new JLabel();
        JLabel lbDesbloqueo = new JLabel();
        JLabel lbPago = new JLabel();
        
        URL urlCall = this.getClass().getResource("/Iconos/Llamada.png");  
        URL urlMail = this.getClass().getResource("/Iconos/email.png");  
        URL urlBloqueo = this.getClass().getResource("/Iconos/bloquear.png");  
        URL urlDesbloqueo = this.getClass().getResource("/Iconos/Desbloquear.png");  
        URL urlPago = this.getClass().getResource("/Iconos/pago.png");  
        
        ImageIcon IconoCall =  new ImageIcon(urlCall); 
        ImageIcon IconoMail =  new ImageIcon(urlMail); 
        ImageIcon IconoBloqueo =  new ImageIcon(urlBloqueo); 
        ImageIcon IconoDesbloqueo =  new ImageIcon(urlDesbloqueo); 
        ImageIcon IconoPago =  new ImageIcon(urlPago); 
        
        lbCall.setIcon(IconoCall);
        lbMail.setIcon(IconoMail);
        lbBloqueo.setIcon(IconoBloqueo);
        lbDesbloqueo.setIcon(IconoDesbloqueo);
        lbPago.setIcon(IconoPago);
        
        String Tipo = " and tipo in (";
        
        if(chkContactos.isSelected())
            Tipo = Tipo + "1,2,";
        if(chkBloqueos.isSelected())
            Tipo = Tipo + "3,4,";
        if(chkPagos.isSelected())
            Tipo = Tipo + "5,";
        
        Tipo = Tipo.substring(1, Tipo.length()-1);
        
        Tipo = Tipo + ") \n";
        
        while(tm.getRowCount()>0)
            tm.removeRow(0); 
        
        try {
            
        
                    Rs = Sql.Select("select tipo,fecha,usuario,texto,id,fcompromiso\n" +
                            "from cli_cobranzablog\n" +
                            "where rut="+ Rut +"\n" +
                            "and codigo_oc="+ Codigo_Oc +"\n" +
                            Tipo +
                            "order by id desc");
            while(Rs.next()){
                
                //Tipo 0 = Llamada
                if(Rs.getInt("tipo")==1){
                    tm.addRow(new Object[]{lbCall,sdf.format(Rs.getTimestamp("fecha")),Rs.getString("id")});
                    
                }
                //Tipo 1 = Correo
                else if(Rs.getInt("tipo")==2) {
                    tm.addRow(new Object[]{lbMail,sdf.format(Rs.getTimestamp("fecha")),Rs.getString("id")});
                }
                // Tipo 2 = Bloque
                else if(Rs.getInt("tipo")==3) {
                    tm.addRow(new Object[]{lbBloqueo,sdf.format(Rs.getTimestamp("fecha")),Rs.getString("id")});
                }
                // Tipo 3 = Desbloqueo
                else if(Rs.getInt("tipo")==4) {
                    tm.addRow(new Object[]{lbDesbloqueo,sdf.format(Rs.getTimestamp("fecha")),Rs.getString("id")});
                }
                // Tipo 5 = Pago
                else if(Rs.getInt("tipo")==5) {
                    tm.addRow(new Object[]{lbPago,sdf.format(Rs.getTimestamp("fecha")),Rs.getString("id")});
                }
                
                
                //Mensaje
                tm.addRow(new Object[]{" ",Rs.getString("texto"),Rs.getString("id")});
                
                try {
                    tm.addRow(new Object[]{" ", "Compromiso: " + sdf2.format(Rs.getTimestamp("fcompromiso"))});
                } catch (Exception e) {
                }
                
        
                
            }
            } catch (Exception e) {
                System.out.println(e.getMessage());
        }
        
    }
    private void btDesbloquearActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btDesbloquearActionPerformed
        jdDesbloquearCliente dcli = new jdDesbloquearCliente(null, true);
        dcli.CargaDatos(Grilla.getValueAt(Grilla.getSelectedRow(),0).toString().trim(), Grilla.getValueAt(Grilla.getSelectedRow(),1).toString().trim(), Grilla.getValueAt(Grilla.getSelectedRow(),2).toString().trim());
        dcli.setLocationRelativeTo(null);
        dcli.setTitle("Desbloquear");
        dcli.setVisible(true);
        
    }//GEN-LAST:event_btDesbloquearActionPerformed

    private void btBuscarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btBuscarActionPerformed
        CargaMorosos();        // TODO add your handling code here:
    }//GEN-LAST:event_btBuscarActionPerformed

    private void btEmailActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btEmailActionPerformed
        String Mensaje="Estimado Cliente\n saludos";

        try {
            Mensaje = java.net.URLEncoder.encode(Mensaje, "utf-8");
            Mensaje = Mensaje.replace("+", "%20");
            System.out.println(Mensaje);
            java.awt.Desktop.getDesktop().mail(java.net.URI.create("mailto:nadie@nadie.com?cc=juanperez@yahoo.com&cco=juanperez2@yahoo.com&subject=prueba&body="+ Mensaje));
            //Process p = Runtime.getRuntime().exec ("'mailto:nadie@nadie.com?cc=juanperez@yahoo.com&cco=juanperez2@yahoo.com&subject=prueba'");
            //            Process p=Runtime.getRuntime().exec ("cmd /c dir");
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }
        // TODO add your handling code here:
    }//GEN-LAST:event_btEmailActionPerformed

    private void chkContactosActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_chkContactosActionPerformed
        CargaBlog(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString(), Grilla.getValueAt(Grilla.getSelectedRow(), 2).toString());
    }//GEN-LAST:event_chkContactosActionPerformed

    private void chkBloqueosActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_chkBloqueosActionPerformed
        CargaBlog(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString(), Grilla.getValueAt(Grilla.getSelectedRow(), 2).toString());
    }//GEN-LAST:event_chkBloqueosActionPerformed

    private void btAgregarBlogActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btAgregarBlogActionPerformed
        
        
        JFrame frame = new JFrame("nrodocto");
        String nrodocto = JOptionPane.showInputDialog(frame, "Ingrese numero de Factura");
        if(nrodocto != null && !nrodocto.isEmpty())
        {
          System.out.println("no nulo");
          ResultSet Rs1;
          ExeSql Sql1= new ExeSql();
          try 
          {
              Rs1 = Sql1.Select("select count(rut) from ctactecli where rut="+Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString()+ " and nrodocto= "+nrodocto);
              Rs1.next();
              if(Rs1.getString("count").equals("0"))
              {
                fmMain.Mensaje("Numero de documento invalido");
                return;
              }
          }
          catch (Exception e)
          {
              fmMain.Mensaje("Error: "+e);
              return;
          }
          finally
          {
              Sql1.Close();
          }
        }
        else{
            System.out.println("nulo");
            return;
        }
        
       
        jdCliBlogAgregar AddBlog = new jdCliBlogAgregar(null, true);
        AddBlog.SetDatosClientes(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString(), Grilla.getValueAt(Grilla.getSelectedRow(), 2).toString(), nrodocto);
        AddBlog.setTitle("Nuevo Evento");
        AddBlog.setLocationRelativeTo(btAgregarBlog);
        AddBlog.setVisible(true);
    }//GEN-LAST:event_btAgregarBlogActionPerformed

    private void chkPagosActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_chkPagosActionPerformed
        CargaBlog(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString(), Grilla.getValueAt(Grilla.getSelectedRow(), 2).toString());
    }//GEN-LAST:event_chkPagosActionPerformed

    private void btEliminaBlogActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btEliminaBlogActionPerformed
        if(fmMain.OkCancel("¿Eliminar el registro")== JOptionPane.OK_OPTION){
            ExeSql Sql = new ExeSql();
            try {
                Sql.ExeSql("delete from cli_cobranzablog where id=" +  GrillaBlog.getValueAt(GrillaBlog.getSelectedRow(),2));
                Sql.Commit();
                CargaBlog(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString(), Grilla.getValueAt(Grilla.getSelectedRow(), 2).toString());
            } catch (Exception e) {
                fmMain.Mensaje(e.getMessage());
            }finally{
                Sql.Close();
            }
        }
    }//GEN-LAST:event_btEliminaBlogActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTable Grilla;
    private javax.swing.JTable GrillaBlog;
    private javax.swing.JTable GrillaDoc;
    private javax.swing.JTable GrillaOCC;
    private javax.swing.JButton btAgregarBlog;
    private javax.swing.JButton btBuscar;
    private javax.swing.JButton btDesbloquear;
    private javax.swing.JButton btEliminaBlog;
    private javax.swing.JButton btEmail;
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JCheckBox chkBloqueos;
    private javax.swing.JCheckBox chkContactos;
    private javax.swing.JCheckBox chkPagos;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JScrollPane jScrollPane3;
    private javax.swing.JScrollPane jScrollPane5;
    private javax.swing.JRadioButton rbOc;
    private javax.swing.JRadioButton rbTodos;
    // End of variables declaration//GEN-END:variables
}
