/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package PanelForm;

import Conexion.ExeSql;
import Dialogos.jdBuscarCliPrv;
import Formularios.fmMain;
import static Formularios.fmMain.pnPestanas;
import Utilidades.PanelTab;
import java.awt.event.KeyEvent;
import java.sql.ResultSet;
import javax.swing.SwingConstants;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author David Alcaman
 */
public class pfPRVPendientes extends javax.swing.JPanel {
DefaultTableCellRenderer rightRenderer = new DefaultTableCellRenderer();
    /**
     * Creates new form pfPRVPendientes
     */
    public pfPRVPendientes() {
        initComponents();
        rightRenderer.setHorizontalAlignment(SwingConstants.RIGHT);
        Grilla.getColumnModel().getColumn(7).setCellRenderer(rightRenderer);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        buttonGroup2 = new javax.swing.ButtonGroup();
        jPanel1 = new javax.swing.JPanel();
        rbFacturas = new javax.swing.JRadioButton();
        rbGuias = new javax.swing.JRadioButton();
        jRadioButton1 = new javax.swing.JRadioButton();
        rbNCPs = new javax.swing.JRadioButton();
        rbNCPp = new javax.swing.JRadioButton();
        rbNCPu = new javax.swing.JRadioButton();
        jPanel2 = new javax.swing.JPanel();
        rbRut = new javax.swing.JRadioButton();
        rbRutTodos = new javax.swing.JRadioButton();
        txRut = new javax.swing.JTextField();
        btIr = new javax.swing.JButton();
        txProveedor = new javax.swing.JTextField();
        btBuscar = new javax.swing.JButton();
        jScrollPane1 = new javax.swing.JScrollPane();
        Grilla = new javax.swing.JTable();

        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder(javax.swing.BorderFactory.createEtchedBorder(), "Documentos"));

        buttonGroup1.add(rbFacturas);
        rbFacturas.setSelected(true);
        rbFacturas.setText("Facturas sin autorizar");

        buttonGroup1.add(rbGuias);
        rbGuias.setText("Guías de Despacho sin asociar");

        buttonGroup1.add(jRadioButton1);
        jRadioButton1.setText("Todos");

        buttonGroup1.add(rbNCPs);
        rbNCPs.setText("Notas de Crédito sin ocupar");

        buttonGroup1.add(rbNCPp);
        rbNCPp.setText("Notas de Crédito ocupadas parcial");
        rbNCPp.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                rbNCPpActionPerformed(evt);
            }
        });

        buttonGroup1.add(rbNCPu);
        rbNCPu.setText("Notas de Crédito utilizadas");
        rbNCPu.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                rbNCPuActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(38, 38, 38)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(rbNCPs)
                    .addComponent(jRadioButton1)
                    .addComponent(rbGuias)
                    .addComponent(rbFacturas)
                    .addComponent(rbNCPp)
                    .addComponent(rbNCPu))
                .addGap(119, 119, 119))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(rbFacturas)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(rbGuias)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(rbNCPs)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(rbNCPp)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(rbNCPu)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(jRadioButton1)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder(javax.swing.BorderFactory.createEtchedBorder(), "Proveedor"));

        buttonGroup2.add(rbRut);
        rbRut.setText("Rut");

        buttonGroup2.add(rbRutTodos);
        rbRutTodos.setSelected(true);
        rbRutTodos.setText("Todos");

        txRut.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txRutKeyPressed(evt);
            }
        });

        btIr.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos22/Go.png"))); // NOI18N
        btIr.setBorderPainted(false);
        btIr.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btIrActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGap(28, 28, 28)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(rbRutTodos)
                    .addGroup(jPanel2Layout.createSequentialGroup()
                        .addComponent(rbRut)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(txRut, javax.swing.GroupLayout.PREFERRED_SIZE, 80, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btIr, javax.swing.GroupLayout.PREFERRED_SIZE, 26, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(txProveedor, javax.swing.GroupLayout.DEFAULT_SIZE, 420, Short.MAX_VALUE)))
                .addContainerGap())
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(rbRut)
                        .addComponent(txRut, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addComponent(btIr, javax.swing.GroupLayout.PREFERRED_SIZE, 23, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txProveedor, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(rbRutTodos)
                .addContainerGap(18, Short.MAX_VALUE))
        );

        btBuscar.setText("Buscar");
        btBuscar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btBuscarActionPerformed(evt);
            }
        });

        Grilla.setAutoCreateRowSorter(true);
        Grilla.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null}
            },
            new String [] {
                "Rut", "Nombre", "Tipo", "Numero", "Emisión", "Recepción", "Orden", "Monto"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        Grilla.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                GrillaMouseClicked(evt);
            }
        });
        jScrollPane1.setViewportView(Grilla);
        if (Grilla.getColumnModel().getColumnCount() > 0) {
            Grilla.getColumnModel().getColumn(0).setMinWidth(80);
            Grilla.getColumnModel().getColumn(0).setPreferredWidth(80);
            Grilla.getColumnModel().getColumn(0).setMaxWidth(80);
            Grilla.getColumnModel().getColumn(2).setMinWidth(100);
            Grilla.getColumnModel().getColumn(2).setPreferredWidth(100);
            Grilla.getColumnModel().getColumn(2).setMaxWidth(100);
            Grilla.getColumnModel().getColumn(3).setMinWidth(90);
            Grilla.getColumnModel().getColumn(3).setPreferredWidth(90);
            Grilla.getColumnModel().getColumn(3).setMaxWidth(90);
            Grilla.getColumnModel().getColumn(4).setMinWidth(90);
            Grilla.getColumnModel().getColumn(4).setPreferredWidth(90);
            Grilla.getColumnModel().getColumn(4).setMaxWidth(90);
            Grilla.getColumnModel().getColumn(5).setMinWidth(90);
            Grilla.getColumnModel().getColumn(5).setPreferredWidth(90);
            Grilla.getColumnModel().getColumn(5).setMaxWidth(90);
            Grilla.getColumnModel().getColumn(6).setMinWidth(90);
            Grilla.getColumnModel().getColumn(6).setPreferredWidth(90);
            Grilla.getColumnModel().getColumn(6).setMaxWidth(90);
            Grilla.getColumnModel().getColumn(7).setMinWidth(90);
            Grilla.getColumnModel().getColumn(7).setPreferredWidth(90);
            Grilla.getColumnModel().getColumn(7).setMaxWidth(90);
        }

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(btBuscar))
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 981, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(30, 30, 30))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(33, 33, 33)
                        .addComponent(btBuscar))
                    .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 460, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

private void CargaProveedor(String Rut){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        try {
            Rs = Sql.Select("select rut,nombre\n" +
                            "from proveedor\n" +
                            "where rut=" + Rut);
            if(Sql.GetRowCount()==0) return;
            
            Rs.next();
            txRut.setText(Rs.getString("Rut"));
            txProveedor.setText(Rs.getString("Nombre"));
            btBuscar.doClick();
            
        } catch (Exception e) {
            System.out.println(e);
        }
        finally{
            Sql.Close();
        }
        
    }


    private void btIrActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btIrActionPerformed
if(!txRut.getText().isEmpty())
            CargaProveedor(txRut.getText());
        else{
            jdBuscarCliPrv BPC = new jdBuscarCliPrv(null, true);
            BPC.setLocationRelativeTo(null);
            BPC.setTitle("Buscar Proveedor");
            BPC.SetTipo(1);
            BPC.setVisible(true);
            CargaProveedor(BPC.GetRut());
        }        // TODO add your handling code here:
    }//GEN-LAST:event_btIrActionPerformed

    private void btBuscarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btBuscarActionPerformed
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel TableModel = (DefaultTableModel) Grilla.getModel();
        String Query;
        int elige = 1;
        String Orden = "0";
        
        
        
        fmMain.LimpiaGrilla(TableModel);
        
        try {
            if(rbFacturas.isSelected()) {
            
               Query = "select c.rut,p.nombre, case c.tipdocto when 'FAP' then 'Factura' when 'FAG' then 'Factura Gasto' when 'GDP' then 'Guía' else 'Otro' end as tipo,\n" +
                        "c.nrodocto, c.femision as femision,cast(c.fcreacion as date) as frecepcion, c.nrodocorigen As orden, c.totaldocto\n" +
                        "from ctacteprv c\n" +
                        "left join proveedor p on c.rut=p.rut\n" +
                        "where not EXISTS (select * from prv_cuentasxpagar cpp where cpp.tipdocto=c.tipdocto and cpp.rut=c.rut and cpp.nrodocto=c.nrodocto)\n" +
                        "and c.tipdocto IN('FAP','FAG')\n" +
                        "and c.autoriza=0\n";
                
               elige = 1; 
               
            }else if(rbGuias.isSelected()){
                
                Query = "select c.rut,p.nombre, case c.tipdocto when 'FAP' then 'Factura' when 'GDP' then 'Guía' else 'Otro' end as tipo,\n" +
                                "c.nrodocto, c.femision as femision,cast(c.fcreacion as date) as frecepcion," +
                                "c.totaldocto, case when rp.ocp is NULL then 0 else rp.ocp end As orden \n" +
                                "from ctacteprv c\n" +
                                "left join proveedor p on c.rut=p.rut\n" +
                                "left join recepcionprv rp on c.nrodocto=rp.nrodocto and c.tipdocto = rp.tipdocto \n" +
                                "where c.tipdocto='GDP'\n" +
                                "and nrodocorigen is NULL\n";
                
                 elige = 2; 
            
            }else if(rbNCPs.isSelected()){
                
                Query = "select c.rut,p.nombre, c.tipdocto as tipo,\n" +
                        "c.nrodocto, c.femision as femision,cast(c.fcreacion as date) as frecepcion,"+
                        "c.totaldocto \n" +
                        "from ctacteprv c\n" +
                        "left join proveedor p on c.rut=p.rut\n" +
                        "where c.tipdocto IN ('NCP') \n" +
                        "and c.pagado = 0 \n" +
                        "and c.autoriza = 1 ";
                
                elige = 3; 
            
            }else if(rbNCPp.isSelected()){
                
                Query = "select c.rut,p.nombre, c.tipdocto as tipo,\n" +
                        "c.nrodocto, c.femision as femision,cast(c.fcreacion as date) as frecepcion,"+
                        "c.totaldocto \n" +
                        "from ctacteprv c\n" +
                        "left join proveedor p on c.rut=p.rut\n" +
                        "where c.tipdocto IN ('NCP') \n" +
                        "and c.autoriza = 2 ";
                 elige = 4; 
            
            }else if(rbNCPu.isSelected()){
                
                Query = "select c.rut,p.nombre, c.tipdocto as tipo,\n" +
                        "c.nrodocto, c.femision as femision,cast(c.fcreacion as date) as frecepcion,"+
                        "c.totaldocto \n" +
                        "from ctacteprv c\n" +
                        "left join proveedor p on c.rut=p.rut\n" +
                        "where c.tipdocto IN ('NCP') \n" +
                        "and c.autoriza = 3 ";
                 elige = 4; 
            
            }else{
                
                Query = "select c.rut,p.nombre, case c.tipdocto when 'FAP' then 'Factura' when 'GDP' then 'Guía' else 'Otro' end as tipo,\n" +
                                "c.nrodocto, c.femision as femision,cast(c.fcreacion as date) as frecepcion,\n" +
                                "(select max(ocp) from recepcionprv where tipdocto=c.tipdocto and rut=c.rut and nrodocto=c.nrodocto) as Orden, c.totaldocto\n" +
                                "from ctacteprv c\n" +
                                "left join proveedor p on c.rut=p.rut\n" +
                                "where (c.tipdocto = 'GDP' and nrodocorigen is NULL) or (c.tipdocto='FAP' and c.autoriza=0)\n";
                 elige = 0; 
            }
            
            if(rbRut.isSelected()){
                Query = Query + " and c.rut=" + txRut.getText().trim() + "\n";
            }    
                
            Query = Query + "order by c.femision" ;
            
            Rs = Sql.Select(Query);
            
            while(Rs.next()){
                
                if (elige == 1 || elige == 2){
                
                    Orden = Rs.getString("orden").trim();
                
                }else {
                
                    Orden = "0";
                
                }
                
                
                
                
                
                TableModel.addRow(new Object[]{Rs.getString("rut").trim(), 
                                               Rs.getString("nombre").trim(), 
                                               Rs.getString("tipo").trim(),
                                               Rs.getString("nrodocto").trim(), 
                                               Rs.getString("femision").trim(), 
                                               Rs.getString("frecepcion").trim(), 
                                               Orden,
                                               fmMain.FormatoTotal(Rs.getDouble("totaldocto"))});
            }
            
        } catch (Exception e) {
            System.out.println("Error " + e.getMessage());
//            fmMain.Mensaje(e.getMessage());
        }finally{
            Sql.Close();
        }
    }//GEN-LAST:event_btBuscarActionPerformed

    private void GrillaMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_GrillaMouseClicked
        if(evt.getClickCount()==2 && Grilla.getValueAt(Grilla.getSelectedRow(), 2).toString().trim().equals("Factura")){
            pfFAProveedor FAP = new pfFAProveedor();
            FAP.setOpaque(false);
            pnPestanas.addTab("FACTURA PROVEEDOR", FAP);
            FAP.CargaFactura(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim(), Grilla.getValueAt(Grilla.getSelectedRow(), 3).toString().trim());
            PanelTab btc=new PanelTab(pnPestanas,0);
            pnPestanas.setTabComponentAt(pnPestanas.indexOfComponent(FAP), btc);
            pnPestanas.setSelectedIndex(pnPestanas.getTabCount()-1);
        }
    }//GEN-LAST:event_GrillaMouseClicked

    private void txRutKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txRutKeyPressed
        if(evt.getKeyCode()==KeyEvent.VK_ENTER)
            btIr.doClick();
    }//GEN-LAST:event_txRutKeyPressed

    private void rbNCPpActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_rbNCPpActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_rbNCPpActionPerformed

    private void rbNCPuActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_rbNCPuActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_rbNCPuActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTable Grilla;
    private javax.swing.JButton btBuscar;
    private javax.swing.JButton btIr;
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.ButtonGroup buttonGroup2;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JRadioButton jRadioButton1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JRadioButton rbFacturas;
    private javax.swing.JRadioButton rbGuias;
    private javax.swing.JRadioButton rbNCPp;
    private javax.swing.JRadioButton rbNCPs;
    private javax.swing.JRadioButton rbNCPu;
    private javax.swing.JRadioButton rbRut;
    private javax.swing.JRadioButton rbRutTodos;
    private javax.swing.JTextField txProveedor;
    private javax.swing.JTextField txRut;
    // End of variables declaration//GEN-END:variables
}
