/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package PanelForm;

import Conexion.ExeSql;
import Formularios.fmMain;
import static PanelForm.pfGDCliente.GetCol;
import java.sql.ResultSet;
import javax.swing.JOptionPane;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author David Alcaman
 */
public class pfAutorizaAjustes extends javax.swing.JPanel {

    /**
     * Creates new form pfOCC_AutorizaMargen
     */
    public pfAutorizaAjustes() {
        initComponents();
        Grilla.getSelectionModel().addListSelectionListener(new ListSelectionListener() {
            //Se ejecuta automáticamente cada vez que se hace una nueva selección. 
            @Override
            public void valueChanged(ListSelectionEvent e) {
                if(Grilla.getSelectedRowCount()>0)
                   CargaDetalle();
                    
            }

        });
     
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        buttonGroup1 = new javax.swing.ButtonGroup();
        jPanel1 = new javax.swing.JPanel();
        btActualizar = new javax.swing.JButton();
        btAutorizar = new javax.swing.JButton();
        jScrollPane1 = new javax.swing.JScrollPane();
        Grilla = new javax.swing.JTable();
        jScrollPane3 = new javax.swing.JScrollPane();
        GrillaDet = new javax.swing.JTable();

        jPanel1.setBorder(javax.swing.BorderFactory.createEtchedBorder());

        btActualizar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos/refresh16.png"))); // NOI18N
        btActualizar.setText("Actualizar");
        btActualizar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btActualizarActionPerformed(evt);
            }
        });

        btAutorizar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/ok_16.png"))); // NOI18N
        btAutorizar.setText("Autorizar");
        btAutorizar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btAutorizarActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addComponent(btActualizar)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 1084, Short.MAX_VALUE)
                .addComponent(btAutorizar)
                .addGap(63, 63, 63))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(27, 27, 27)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btAutorizar)
                    .addComponent(btActualizar))
                .addContainerGap(38, Short.MAX_VALUE))
        );

        Grilla.setAutoCreateRowSorter(true);
        Grilla.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null}
            },
            new String [] {
                "FOLIO", "MOTIVO", "COMENTARIO", "USUARIO", "FECHA"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        Grilla.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                GrillaMouseClicked(evt);
            }
        });
        Grilla.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                GrillaKeyPressed(evt);
            }
        });
        jScrollPane1.setViewportView(Grilla);
        if (Grilla.getColumnModel().getColumnCount() > 0) {
            Grilla.getColumnModel().getColumn(0).setMinWidth(75);
            Grilla.getColumnModel().getColumn(0).setPreferredWidth(75);
            Grilla.getColumnModel().getColumn(0).setMaxWidth(75);
            Grilla.getColumnModel().getColumn(1).setMinWidth(400);
            Grilla.getColumnModel().getColumn(1).setPreferredWidth(400);
            Grilla.getColumnModel().getColumn(1).setMaxWidth(400);
            Grilla.getColumnModel().getColumn(2).setMinWidth(300);
            Grilla.getColumnModel().getColumn(2).setPreferredWidth(300);
            Grilla.getColumnModel().getColumn(2).setMaxWidth(400);
            Grilla.getColumnModel().getColumn(3).setMinWidth(120);
            Grilla.getColumnModel().getColumn(3).setPreferredWidth(120);
            Grilla.getColumnModel().getColumn(3).setMaxWidth(120);
            Grilla.getColumnModel().getColumn(4).setMinWidth(100);
            Grilla.getColumnModel().getColumn(4).setPreferredWidth(100);
            Grilla.getColumnModel().getColumn(4).setMaxWidth(150);
        }

        GrillaDet.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null, null, null},
                {null, null, null, null, null, null, null, null, null, null}
            },
            new String [] {
                "Código", "Nombre", "Unidad", "Stock Actual", "Acción", "Cantidad", "Stock Final", "tipo", "NomUbica", "CodUbica"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.Object.class, java.lang.Object.class, java.lang.Object.class, java.lang.Double.class, java.lang.Object.class, java.lang.Double.class, java.lang.Double.class, java.lang.Integer.class, java.lang.Object.class, java.lang.Object.class
            };
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false, false, false, false, true, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane3.setViewportView(GrillaDet);
        if (GrillaDet.getColumnModel().getColumnCount() > 0) {
            GrillaDet.getColumnModel().getColumn(7).setMinWidth(0);
            GrillaDet.getColumnModel().getColumn(7).setPreferredWidth(0);
            GrillaDet.getColumnModel().getColumn(7).setMaxWidth(0);
            GrillaDet.getColumnModel().getColumn(9).setMinWidth(0);
            GrillaDet.getColumnModel().getColumn(9).setPreferredWidth(0);
            GrillaDet.getColumnModel().getColumn(9).setMaxWidth(0);
        }

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 1347, Short.MAX_VALUE)
            .addComponent(jScrollPane3)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 215, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(jScrollPane3, javax.swing.GroupLayout.PREFERRED_SIZE, 305, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(120, Short.MAX_VALUE))
        );
    }// </editor-fold>//GEN-END:initComponents
    
//    private void CargaDato(){
//        ExeSql Sql = new ExeSql();
//        ResultSet Rs;
//        
//        try {
//            Rs = Sql.Select("select valor\n" +
//                            "from par_general\n" +
//                            "where tipo='UMBRALDEMARGEN'");
//            Rs.next();
//            lbMargen.setText(Rs.getString("valor").trim() + "%");
//        } catch (Exception e) {
//        }finally{
//            Sql.Close();
//        }
//    }

    private void CargaDetalle(){
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel ModelDet = (DefaultTableModel) GrillaDet.getModel();
        fmMain.LimpiaGrilla(ModelDet);
        
        try {
            Rs = Sql.Select("select d.folio, p.nombre,u.unidad,d.cantidad,d.valorunitario,p.costofinal,(d.valorunitario-p.costofinal)*100/d.valorunitario as margen\n" +
                            "from ajustedet_autoriza d\n" +
                            "left join producto p on d.sku=p.sku\n" +
                            "left join par_unidad u on u.codigo=p.unidad\n" +
                            " where d.folio ="+ Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim());
                            
            while(Rs.next()){
                ModelDet.addRow(new Object[]{
                        Rs.getString("sku").trim(),
                        Rs.getString("nombre").trim(),
                        Rs.getString("unidad").trim(),
                        Rs.getDouble("cantidad"),
                        Rs.getDouble("valorunitario"),
                        Rs.getDouble("costofinal"),
                        Rs.getInt("margen")
                        
                });
            }
        } catch (Exception e) {
        }finally{
            Sql.Close();
        }
    }
    private void btActualizarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btActualizarActionPerformed

        actualizaDatos();
    }//GEN-LAST:event_btActualizarActionPerformed

    
    private void actualizaDatos(){
    
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel Model = (DefaultTableModel)Grilla.getModel();
        DefaultTableModel ModelDet = (DefaultTableModel) GrillaDet.getModel();
        
        
        fmMain.LimpiaGrilla(Model);
        fmMain.LimpiaGrilla(ModelDet);

       
        try {

            
            
    //Llena encabezado de ajuste a autorizar        
           Rs = Sql.Select("select a.folio,c.motivo,a.comentario,a.usuario,a.fecha\n" +
                            "from ajusteenc_autoriza a\n" +
                            "left join par_ajustemotivo c on a.motivo=c.codigo\n" +
                            "where a.autorizado = false");
            
            while(Rs.next()){
                Model.addRow(new Object[]{
                    Rs.getString("folio").trim(),
                    Rs.getString("motivo").trim(),
                    Rs.getString("comentario").trim(),
                    Rs.getString("usuario").trim(),
                    Rs.getString("fecha").trim()
                });
            }
            

            
            
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }
}
    
    
    private void ajustar_autorizado()
    {
        String Query="";
        ExeSql Sql = new  ExeSql();
        ResultSet Rs, Rs1;
        String QuerySuma="", QueryResta="", Query2="", QryUpd="", QryIns="" ;
        String Sku="", Scant="", Stransito="";
        
        try {
    
            //Productos
            for(int i=0;i< GrillaDet.getRowCount();i++){
                           
//                GrillaDet.getValueAt(i, 0).toString() + "',\n" +
//                            fmMain.SetGuardar(GrillaDet.getValueAt(i, 4).toString().trim()) + ",\n" +
//                            GrillaDet.getValueAt(i, 5).toString() + ",\n" +
//                            "'" + GrillaDet.getValueAt(i, 7).toString().trim() + "')\n";
//                ______________________________________________________________________________________________________                
// ESTE PROCESO SE REALIZARÀ CUANDO SE AUTORICE EL AJUSTE                 
                Sku = GrillaDet.getValueAt(i, 0).toString();
                Scant = fmMain.SetGuardar(GrillaDet.getValueAt(i, 5).toString().trim());
                Stransito = fmMain.BodegaTransito();
                
                // Actualiza Stock inicial y final de las tabla detalle de autorizacion
                
                       QryUpd = "update ajustedet_autoriza set stockini = " + GrillaDet.getValueAt(i, 3).toString().trim() +
                               ", stockfin = " + GrillaDet.getValueAt(i, 6).toString().trim() + " where sku = '" +  Sku + "' and folio = " +  Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim() + ""; 
                       Sql.ExeSql(QryUpd);
                
                
                
                
                
                   if (GrillaDet.getValueAt(i, 4).toString().equals("Restar")){
                       QueryResta = "update mt_productos set cant = cant - " + Scant +
                               " where sku = '" +  Sku + "' and ubicacion = '" +  GrillaDet.getValueAt(i, 9).toString().trim() + "'"; 
                       Sql.ExeSql(QueryResta);
                   }// Fin Si Resta         
                   
                   
                   if (GrillaDet.getValueAt(i, 4).toString().equals("Sumar")){
                       
                  //---------------------------------------------------------------------------------------           
                    Query2 = "select *  from mt_productos where ubicacion = '" + fmMain.BodegaTransito() + "' and sku = '" + Sku + "';";
                    Rs1 = Sql.Select(Query2);
                    // Averigua si el producto esta o no en la ubicacion de Transito
                     if (Rs1.next()){
                        // Realiza un Update Si esta
                       QuerySuma = "update mt_productos set cant = cant + " + Scant +
                                " ,  usuario_mod ='" +fmMain.GetUsuario() + "', fecha_mod = now() " +
                               " where sku = '" + Sku + "' and ubicacion = '" +  Stransito  + "'"; 
                       Sql.ExeSql(QuerySuma);
                       
                       }   // SI SUMA
                     else
                     {
                         // Inserta el producto Si no lo encuentra
                        QryIns = "insert into mt_productos (ubicacion,sku,usuario,cant)\n" +
                        " values ('" + Stransito + "','" + Sku + "','" + fmMain.GetUsuario()  + "', " + Scant + ");";
                        Sql.ExeSql(QryIns);
                        
                     } /// Fin SI Suma
            //-------------------------------------------------------------------------------------

                   }// Fin Si es Suma         
                   
            } // Fin For de Detalle
            
            Sql.Commit();
            fmMain.Mensaje("Ajuste Realizado.\n ");
            //AbrirFolio(Folio);
            
        } catch (Exception e) {
            System.out.println(e);
            Sql.Rollback();
        } finally{
            Sql.Close();
        }
        
        
        
        
    }            
    
    
    
    private void btAutorizarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btAutorizarActionPerformed
        ExeSql Sql = new ExeSql();
        String Qry = "";
        try {
            
            if (Grilla.getRowCount()==0){
                fmMain.Mensaje("No se puede autorizar no hay registros");
                return;
            }
           
            Sql.ExeSql("update ajusteenc_autoriza set autorizado=true, usuario_autoriza=user, fecha_autoriza= now() where folio =" + Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim());
            ajustar_autorizado();

            Sql.Commit();
            fmMain.Mensaje("Ajuste Autorizada");
            actualizaDatos();
        } catch (Exception e) {
            System.out.println(e.getMessage());
            fmMain.Mensaje("Ocurrio un error");
        } finally{
            Sql.Close();
        }
    }//GEN-LAST:event_btAutorizarActionPerformed

    private void GrillaKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_GrillaKeyPressed
        // TODO add your handling code here:
        
        
    }//GEN-LAST:event_GrillaKeyPressed

    private void GrillaMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_GrillaMouseClicked
        // TODO add your handling code here:
        
        trae_detalle(Grilla.getValueAt(Grilla.getSelectedRow(), 0).toString().trim());
    }//GEN-LAST:event_GrillaMouseClicked

    
    private void trae_detalle(String folio){
        
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        DefaultTableModel TableModel = (DefaultTableModel) GrillaDet.getModel();
        String Ubic ="",CodUbic="";
        while(TableModel.getRowCount()>0)
           TableModel.removeRow(0);
     try{
           //Carga Productos
            Rs = Sql.Select("select d.sku,p.nombre,u.unidad,i.stock + d.cantidad stockfin,\n" +
                            "case d.tipo when 0 then 'Sumar' when 1 then 'Restar' else 'Dejar en' end as ElTipo ,d.cantidad,d.tipo, d.ubicacion, cm.nombre descr_metro, i.stock\n" +
                            "from ajustedet_autoriza d\n" +
                            "left join producto p on d.sku=p.sku\n" +
                            "left join par_unidad u on p.unidad=u.codigo\n" +
                            "left join mt_codmetro cm on d.ubicacion = cm.codmetro\n" +
                            "left join inventario i on i.sku = d.sku\n" +
                            "where d.folio=" + folio  );
            
            while(Rs.next()){
                
                if (Rs.getString("descr_metro")==null)
                {
                     Ubic= "Sin Ubic";
                     CodUbic="";
                }
                else
                {
                    Ubic= Rs.getString("descr_metro").trim();
                    CodUbic =Rs.getString("ubicacion").trim();
                }
                    
                
                
                TableModel.addRow(new Object[]{
                        Rs.getString("Sku").trim(), 
                        Rs.getString("Nombre").trim(), 
                        Rs.getString("unidad").trim(),
                        Rs.getDouble("stock"),
                        Rs.getString("ElTipo").trim(),
                        Rs.getDouble("cantidad"),
                        Rs.getDouble("stockfin"),
                        Rs.getInt("tipo"),
                        Ubic,CodUbic
                       });
            }
        
        
                
                
        } catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }    
            
            
    }
    

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTable Grilla;
    private javax.swing.JTable GrillaDet;
    private javax.swing.JButton btActualizar;
    private javax.swing.JButton btAutorizar;
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane3;
    // End of variables declaration//GEN-END:variables
}
