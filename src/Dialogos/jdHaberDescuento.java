/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package Dialogos;

import Conexion.ExeSql;
import Formularios.fmMain;
import java.sql.ResultSet;
import javax.swing.JOptionPane;
import javax.swing.UIManager;
import org.exolab.castor.mapping.xml.Sql;

/**
 *
 * @author Cdiaz
 */
public class jdHaberDescuento extends javax.swing.JDialog {
    boolean Nuevo;
    int Codigo;
    /**
     * Creates new form jdHaberDescuento
     */
    public jdHaberDescuento(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
        initComponents();
        CargaCombo();
        Nuevo = false;
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        cbTipo = new javax.swing.JComboBox<>();
        cbCuenta = new javax.swing.JComboBox<>();
        chkVigente = new javax.swing.JCheckBox();
        btGuardar = new javax.swing.JButton();
        btCerrar = new javax.swing.JButton();
        btNuevo = new javax.swing.JButton();
        cbNombre = new javax.swing.JComboBox<>();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setIconImage(null);

        jLabel1.setText("Tipo");

        jLabel2.setText("Nombre");

        jLabel3.setText("Vigente");

        jLabel4.setText("Cuenta");

        cbTipo.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Seleccione tipo", "Haber", "Descuento" }));
        cbTipo.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cbTipoActionPerformed(evt);
            }
        });

        cbCuenta.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Seleccione Cuenta" }));
        cbCuenta.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cbCuentaActionPerformed(evt);
            }
        });

        chkVigente.setText("Inactivo");
        chkVigente.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                chkVigenteActionPerformed(evt);
            }
        });

        btGuardar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/save16.png"))); // NOI18N
        btGuardar.setText("Guardar");
        btGuardar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btGuardarActionPerformed(evt);
            }
        });

        btCerrar.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/Cancel16.png"))); // NOI18N
        btCerrar.setText("Cerrar");
        btCerrar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btCerrarActionPerformed(evt);
            }
        });

        btNuevo.setIcon(new javax.swing.ImageIcon(getClass().getResource("/Iconos16/Agregar.png"))); // NOI18N
        btNuevo.setText("Nuevo");
        btNuevo.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseReleased(java.awt.event.MouseEvent evt) {
                btNuevoMouseReleased(evt);
            }
        });
        btNuevo.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btNuevoActionPerformed(evt);
            }
        });

        cbNombre.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Seleccione Nombre" }));
        cbNombre.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cbNombreActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(148, 148, 148)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(btNuevo, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(btGuardar, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(btCerrar, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(30, 30, 30)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(jLabel4)
                            .addComponent(jLabel3)
                            .addComponent(jLabel2)
                            .addComponent(jLabel1))
                        .addGap(28, 28, 28)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(cbCuenta, 0, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(cbNombre, 0, 265, Short.MAX_VALUE)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(cbTipo, javax.swing.GroupLayout.PREFERRED_SIZE, 124, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addGap(0, 0, Short.MAX_VALUE))
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(chkVigente)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))))
                .addGap(43, 43, 43))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(27, 27, 27)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(cbTipo, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel2)
                    .addComponent(cbNombre, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel3)
                    .addComponent(chkVigente))
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(cbCuenta, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel4))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 42, Short.MAX_VALUE)
                .addComponent(btNuevo)
                .addGap(18, 18, 18)
                .addComponent(btGuardar)
                .addGap(18, 18, 18)
                .addComponent(btCerrar)
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void cbCuentaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cbCuentaActionPerformed
        
    }//GEN-LAST:event_cbCuentaActionPerformed

    private void btNuevoActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btNuevoActionPerformed
        UIManager.put("OptionPane.cancelButtonText", "HABER");
        UIManager.put("OptionPane.okButtonText", "DESCUENTO"); 
        cbTipo.setEnabled(false);
        if(fmMain.OkCancel("Seleccione una opcion")== JOptionPane.OK_OPTION){
        cbTipo.setSelectedItem("Descuento");
        cbNombre.setEditable(true);
        //String item = cbNombre.getEditor().getItem().toString();
        cbNombre.getEditor().setItem("");
        cbNombre.requestFocus();
        }
        else
        {
        cbTipo.setSelectedItem("Haber");
        cbNombre.setEditable(true);
        //String item = cbNombre.getEditor().getItem().toString();
        cbNombre.getEditor().setItem("");
        cbNombre.requestFocus();   
        }
        UIManager.put("OptionPane.cancelButtonText", "CANCELAR");
        UIManager.put("OptionPane.okButtonText", "OK"); 
        Nuevo = true;
        Codigo = 0;
    }//GEN-LAST:event_btNuevoActionPerformed

    private void btCerrarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btCerrarActionPerformed
        dispose();
    }//GEN-LAST:event_btCerrarActionPerformed

    private void btNuevoMouseReleased(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_btNuevoMouseReleased
        
    }//GEN-LAST:event_btNuevoMouseReleased

    private void cbTipoActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cbTipoActionPerformed
        cbNombre.setModel(new javax.swing.DefaultComboBoxModel(new String[] {}));
        cbNombre.addItem("Seleccione Nombre");
        if (cbTipo.getSelectedIndex()!=0) 
                {
                String tipo;
                
                if (cbTipo.getSelectedItem().equals("Haber"))
                    {tipo = "REM_HABERES";}
                else
                    {tipo = "REM_DESCUENTOS";}
                
                ExeSql Sql = new ExeSql();
                ResultSet Rs;
        try {

                    Rs = Sql.Select("select cuenta, nombre\n" +
                                    "from par_general\n" +
                                    "where tipo='" + tipo + "' order by nombre");
                    while(Rs.next())
                        {
                        cbNombre.addItem(Rs.getString("nombre"));
                        }
                    
        }
        catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }
        }
    }//GEN-LAST:event_cbTipoActionPerformed
    
    
    private void cbNombreActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cbNombreActionPerformed
        ExeSql Sql = new ExeSql();
        ResultSet Rs;

        try {
            Rs = Sql.Select("select p.codigo,p.nombre, p.vigente, c.nombre as nomcuenta \n"
                    + "from par_general p \n"
                    + "left join conta_plan c on c.codigo=p.cuenta where p.nombre='" + cbNombre.getSelectedItem().toString().trim() + "'");
            
            while (Rs.next()) {
                Codigo = Rs.getInt("codigo");
                try {
                    cbCuenta.setSelectedItem(Rs.getString("nomcuenta"));
                } catch (Exception e) {
                    cbCuenta.setSelectedIndex(0);
                }

                if (Rs.getInt("vigente")==1) {
                    chkVigente.setSelected(true);
                    chkVigente.setText("Activo");
                } else {
                    chkVigente.setSelected(false);
                    chkVigente.setText("Inactivo");
                }
            }
        } catch (Exception e) {
            System.out.println(e.getMessage());
        } finally {
            Sql.Close();
        }
    }//GEN-LAST:event_cbNombreActionPerformed

    private void chkVigenteActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_chkVigenteActionPerformed
        if (chkVigente.isSelected())
                chkVigente.setText("Activo");
        else
            chkVigente.setText("Inactivo");
    }//GEN-LAST:event_chkVigenteActionPerformed

    private void btGuardarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btGuardarActionPerformed
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        
        

        try{    
                
                    Rs = Sql.Select("select max(p.codigo) as codigo, max(p.valor) as valor, c.codigo as cuenta \n" +
                                    "from conta_plan c, par_general p \n" +
                                    "where c.nombre='"+ cbCuenta.getSelectedItem().toString().trim() +"' and p.tipo in ('REM_HABERES','REM_DESCUENTOS') group by c.codigo");
                    Rs.next();
                    String cuenta = Rs.getString("cuenta");
                    if(Nuevo){
                        Codigo = Rs.getInt("Codigo");
                    }
                
                
                String nombre = cbNombre.getSelectedItem().toString().trim();
                int vigente;
                if (chkVigente.isSelected())
                {
                vigente = 1;
                }
                else
                {
                vigente = 0;
                }
                
                Sql.ExeSql("delete from par_general where tipo in ('REM_DESCUENTOS','REM_HABERES') and codigo =" + Codigo);
        if (cbTipo.getSelectedItem().equals("Descuento"))  
            {
            Sql.ExeSql("insert into par_general \n" +
                                        "(tipo, codigo, nombre, valor, vigente, cuenta) values (" + 
                                        "'REM_DESCUENTOS',"+ Codigo +",'" + nombre + "'," + Codigo + ","+ vigente +","+ cuenta+")"); 
            }
        else
            {
            Sql.ExeSql("insert into par_general \n" +
                                "(tipo, codigo, nombre, valor, vigente, cuenta) values (" + 
                                "'REM_HABERES',"+ Codigo +",'" + nombre + "'," + Codigo + ","+ vigente +","+ cuenta+")");     
            }
        Sql.Commit();
        if(Nuevo)
            fmMain.Mensaje(cbTipo.getSelectedItem().toString()+" creado con exito");
        else
            fmMain.Mensaje(cbTipo.getSelectedItem().toString()+" actualizado con exito");
        cbTipo.setEnabled(true);
        cbTipo.setSelectedIndex(0);
        cbNombre.setEditable(false);
        cbNombre.setSelectedIndex(0);
        chkVigente.setSelected(false);
        chkVigente.setText("Inactivo");
        cbCuenta.setSelectedIndex(0);
        Nuevo = false;
        Codigo=0;
        }
        catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }
    }//GEN-LAST:event_btGuardarActionPerformed
    public void CargaCombo()
    {
        cbCuenta.setModel(new javax.swing.DefaultComboBoxModel(new String[] {}));
        cbCuenta.addItem("Seleccione Cuenta");
        ExeSql Sql = new ExeSql();
        ResultSet Rs;
        
        try{
        Rs = Sql.Select("select nombre\n" +
                                    "from conta_plan\n" +
                                    "where codigo like '2%' and nivel in(3,4) order by codigo");
                    while(Rs.next())
                        {
                        cbCuenta.addItem(Rs.getString("nombre"));
                        }
        }
        catch (Exception e) {
            System.out.println(e.getMessage());
        }finally{
            Sql.Close();
        }
    }
    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(jdHaberDescuento.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(jdHaberDescuento.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(jdHaberDescuento.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(jdHaberDescuento.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        /* Create and display the dialog */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                jdHaberDescuento dialog = new jdHaberDescuento(new javax.swing.JFrame(), true);
                dialog.addWindowListener(new java.awt.event.WindowAdapter() {
                    @Override
                    public void windowClosing(java.awt.event.WindowEvent e) {
                        System.exit(0);
                    }
                });
                dialog.setVisible(true);
            }
        });
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btCerrar;
    private javax.swing.JButton btGuardar;
    private javax.swing.JButton btNuevo;
    private javax.swing.JComboBox<String> cbCuenta;
    private javax.swing.JComboBox<String> cbNombre;
    private javax.swing.JComboBox<String> cbTipo;
    private javax.swing.JCheckBox chkVigente;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    // End of variables declaration//GEN-END:variables
}
